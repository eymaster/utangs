<!DOCTYPE html><html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Debt Details – Utang Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      padding: 20px;
    }
    .summary-table {
      margin-top: 30px;
    }
  </style>
</head>
<body><div class="container">
  <h2 class="mb-4">Utang Details</h2>  <!-- Summary -->  <div class="summary-table">
    <h5>Summary (Pending)</h5>
    <table class="table table-sm table-bordered" id="summary-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Pending Amount</th>
        </tr>
      </thead>
      <tbody id="summary-body"></tbody>
      <tfoot>
        <tr>
          <th>Total</th>
          <th id="total-pending">₱0.00</th>
        </tr>
      </tfoot>
    </table>
  </div>  <!-- Debt Table -->  <h5 class="mt-4">All Debts</h5>
  <table class="table table-striped table-bordered table-hover table-sm" id="debts-table">
    <thead class="table-dark">
      <tr>
        <th>Name</th>
        <th>Amount</th>
        <th>Reason</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for debt in debts %}
      <tr data-id="{{ debt.id }}">
        <td>{{ debt.name }}</td>
        <td>₱{{ '%.2f'|format(debt.amount) }}</td>
        <td>{{ debt.reason }}</td>
        <td>
          <select class="form-select form-select-sm status-select">
            <option value="Pending" {% if debt.status == 'Pending' %}selected{% endif %}>Pending</option>
            <option value="Paid" {% if debt.status == 'Paid' %}selected{% endif %}>Paid</option>
          </select>
        </td>
        <td>
          <button class="btn btn-sm btn-warning edit-btn">Edit</button>
          <button class="btn btn-sm btn-danger delete-btn">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>  <!-- History Log -->  <h5 class="mt-5">Recent Activity</h5>
  <ul class="list-group">
    {% for log in history_logs %}
    <li class="list-group-item d-flex justify-content-between align-items-center">
      {{ log.action }}
      <span class="badge bg-secondary">{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</span>
    </li>
    {% endfor %}
  </ul>
</div><!-- Modals --><div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this debt?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
      </div>
    </div>
  </div>
</div><script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script><script>
  async function refreshSummary() {
    try {
      const res = await fetch('/summary_data');
      const data = await res.json();
      const tbody = document.getElementById('summary-body');
      tbody.innerHTML = '';
      data.summary.forEach(entry => {
        const row = document.createElement('tr');
        row.innerHTML = `<td>${entry.name}</td><td>₱${entry.amount.toFixed(2)}</td>`;
        tbody.appendChild(row);
      });
      document.getElementById('total-pending').textContent = `₱${data.total.toFixed(2)}`;
    } catch (err) {
      console.error('Failed to update summary:', err);
    }
  }

  async function updateStatus(debtId, newStatus) {
    try {
      const response = await fetch(`/toggle_status/${debtId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status: newStatus })
      });
      const result = await response.json();
      if (result.success) refreshSummary();
    } catch (err) {
      console.error('Error updating status:', err);
    }
  }

  let selectedDeleteId = null;

  document.addEventListener('DOMContentLoaded', () => {
    refreshSummary();

    document.querySelectorAll('.status-select').forEach(select => {
      select.addEventListener('change', function () {
        const debtId = this.closest('tr').getAttribute('data-id');
        updateStatus(debtId, this.value);
      });
    });

    document.querySelectorAll('.delete-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const tr = this.closest('tr');
        selectedDeleteId = tr.getAttribute('data-id');
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
      });
    });

    document.getElementById('confirmDeleteBtn').addEventListener('click', async () => {
      if (!selectedDeleteId) return;
      try {
        const res = await fetch(`/delete/${selectedDeleteId}`, { method: 'DELETE' });
        if (res.ok) {
          document.querySelector(`tr[data-id="${selectedDeleteId}"]`).remove();
          refreshSummary();
        }
      } catch (err) {
        console.error('Delete failed:', err);
      }
      bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
    });

    document.querySelectorAll('.edit-btn').forEach(btn => {
      btn.addEventListener('click', function () {
        const debtId = this.closest('tr').getAttribute('data-id');
        window.location.href = `/edit/${debtId}`;
      });
    });
  });
</script></body>
</html>
