<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>Utang Manager - Debts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    .theme-toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      cursor: pointer;
    }
    .modal-dark .modal-content {
      background-color: #343a40;
      color: white;
    }
    .modal-light .modal-content {
      background-color: #fff;
      color: #000;
    }
  </style>
</head>
<body>
<div class="container mt-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Debts</h2>
    <button id="themeToggle" class="btn btn-outline-secondary">
      <span id="themeIcon">ðŸŒ™</span> <span id="themeLabel">Dark Mode</span>
    </button>
  </div>

  <div id="summary" class="mb-4"></div>

  <table class="table table-bordered table-hover">
    <thead class="table-light">
      <tr>
        <th>Name</th>
        <th>Amount (â‚±)</th>
        <th>Reason</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for debt in debts %}
      <tr>
        <td>{{ debt.name }}</td>
        <td>{{ debt.amount }}</td>
        <td>{{ debt.reason }}</td>
        <td>{{ debt.status }}</td>
        <td>
          <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editModal"
                  data-id="{{ debt.id }}" data-name="{{ debt.name }}" data-amount="{{ debt.amount }}"
                  data-reason="{{ debt.reason }}" data-status="{{ debt.status }}">
            Edit
          </button>
          <button class="btn btn-sm btn-danger" onclick="confirmDelete({{ debt.id }})">Delete</button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <form method="POST" id="editForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Debt</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="edit-id">
          <div class="mb-3">
            <label for="edit-name" class="form-label">Name</label>
            <input type="text" class="form-control" name="name" id="edit-name" required>
          </div>
          <div class="mb-3">
            <label for="edit-amount" class="form-label">Amount</label>
            <input type="number" class="form-control" name="amount" id="edit-amount" required>
          </div>
          <div class="mb-3">
            <label for="edit-reason" class="form-label">Reason</label>
            <input type="text" class="form-control" name="reason" id="edit-reason" required>
          </div>
          <div class="mb-3">
            <label for="edit-status" class="form-label">Status</label>
            <select class="form-select" name="status" id="edit-status">
              <option value="Pending">Pending</option>
              <option value="Paid">Paid</option>
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success">Save Changes</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Confirm Delete</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        Are you sure you want to delete this debt?
      </div>
      <div class="modal-footer">
        <a href="#" id="deleteLink" class="btn btn-danger">Yes, Delete</a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
  const currentTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-bs-theme', currentTheme);
  updateThemeToggle(currentTheme);

  document.getElementById("themeToggle").addEventListener("click", () => {
    const newTheme = document.documentElement.getAttribute("data-bs-theme") === "dark" ? "light" : "dark";
    document.documentElement.setAttribute("data-bs-theme", newTheme);
    localStorage.setItem("theme", newTheme);
    updateThemeToggle(newTheme);
  });

  function updateThemeToggle(theme) {
    const label = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
    const icon = theme === 'dark' ? 'ðŸŒ™' : 'â˜€ï¸';
    document.getElementById("themeLabel").textContent = label;
    document.getElementById("themeIcon").textContent = icon;

    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
      modal.classList.remove('modal-dark', 'modal-light');
      modal.classList.add(theme === 'dark' ? 'modal-dark' : 'modal-light');
    });
  }

  function confirmDelete(id) {
    const deleteModal = new bootstrap.Modal(document.getElementById("deleteModal"));
    document.getElementById("deleteLink").href = "/delete/" + id;
    deleteModal.show();
  }

  const editModal = document.getElementById('editModal');
  editModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    document.getElementById('edit-id').value = button.getAttribute('data-id');
    document.getElementById('edit-name').value = button.getAttribute('data-name');
    document.getElementById('edit-amount').value = button.getAttribute('data-amount');
    document.getElementById('edit-reason').value = button.getAttribute('data-reason');
    document.getElementById('edit-status').value = button.getAttribute('data-status');

    const theme = document.documentElement.getAttribute('data-bs-theme');
    editModal.classList.remove('modal-dark', 'modal-light');
    editModal.classList.add(theme === 'dark' ? 'modal-dark' : 'modal-light');

    document.getElementById('editForm').action = '/edit/' + button.getAttribute('data-id');
  });

  async function fetchSummary() {
    const res = await fetch("/summary_data");
    const data = await res.json();
    const summaryDiv = document.getElementById("summary");

    let html = `<h5>Total Unpaid: â‚±${data.total.toFixed(2)}</h5><ul>`;
    data.summary.forEach(entry => {
      html += `<li><strong>${entry.name}</strong>: â‚±${entry.amount.toFixed(2)}</li>`;
    });
    html += "</ul>";
    summaryDiv.innerHTML = html;
  }

  fetchSummary();
  setInterval(fetchSummary, 5000); // Auto-refresh every 5s
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
